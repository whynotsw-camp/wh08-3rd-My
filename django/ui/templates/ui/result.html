{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'ui/style.css' %}?v=2.8">

<div class="result-container">
    <!-- 헤더 영역 -->
    <div class="result-header" style="text-align: center; margin-top: 40px; margin-bottom: 60px;">
        <h1 class="page-title" style="text-align: center; padding: 0;">My Perfume</h1>
        <p class="page-subtitle" style="text-align: center; color: #888; margin-bottom: 10px;">당신의 향을 찾으세요</p>
        <h2 class="section-header">For Me, 지금의 나에게 어울리는 향은?</h2>
    </div>

    <!-- 상단 코디 및 설명 영역 -->
    <div class="analysis-horizontal-box">
        <div class="clothing-img-box" id="outfit-display-area">
            <span class="material-icons" style="font-size: 60px; color: #ddd;">checkroom</span>
            <p style="font-size: 14px; color: #999;">코디를 불러오는 중...</p>
        </div>

        <div class="llm-explanation-box">
            <h3>분석 결과 및 추천 이유</h3>
            <p>오늘 선택하신 코디와 당신의 취향을 분석한 결과입니다. 선택하신 의상의 무드와 색감을 고려하여, 당신의 인상을 더욱 완성시켜줄 최적의 향기를 찾아냈습니다.<br><br>당신이 선호하는 향료와 현재 시즌의 분위기를 모두 고려하여, 오늘의 룩을 완벽하게 완성해줄 세 가지 향수를 제안해 드립니다.</p>
        </div>
    </div>

    <!-- 하단 향수 추천 영역 -->
    <div class="perfume-grid-container">
        <h3 class="grid-title">TOP3 Quick Pick <span class="material-icons" style="vertical-align: middle; font-size: 18px;">arrow_forward</span></h3>
        <div class="perfume-cards-wrapper" id="perfume-results-container">
            <!-- 자바스크립트 가짜 데이터가 여기에 들어옵니다 -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // 1. [코디 이미지] API 호출 (상단 옷 사진 겹치기 영역)
    fetch('/api/user-outfit/')
        .then(res => res.json())
        .then(data => {
            const outfitArea = document.getElementById('outfit-display-area');
            outfitArea.innerHTML = '';

            if (data.onepiece_img) {
                outfitArea.innerHTML = `<img src="${data.onepiece_img}" class="outfit-card onepiece-card">`;
            } else if (data.top_img && data.bottom_img) {
                outfitArea.innerHTML = `
                    <img src="${data.top_img}" class="outfit-card top-card">
                    <img src="${data.bottom_img}" class="outfit-card bottom-card">
                `;
            } else {
                outfitArea.innerHTML = `<span class="material-icons" style="font-size: 60px; color: #ddd;">checkroom</span><p style="font-size:12px; color:#999;">선택된 이미지가 없습니다.</p>`;
            }
        })
        .catch(err => console.error("이미지 API 에러:", err));

    // 2. [향수 이미지] 전용 API 호출 (별도로 만드신 /api/perfume-top3-images/ 호출)
    fetch('/api/perfume-top3-images/')
        .then(res => res.json())
        .then(perfumeImages => {

            // 3. [향수 텍스트 정보] 디자인 확인용 가짜 데이터
            // 이미지 API에서 준 ID(0, 1, 2)와 순서를 맞췄습니다.
            const fakeData = [
                {
                    perfume_name: "neroli-outrenoir-2024",
                    brand: "Le Labo",
                    gender: "Unisex",
                    top_season: "Summer",
                    accords: ["Fresh", "Floral", "Citrus"],
                    myscore: 289.03
                },
                {
                    perfume_name: "Jo Malone Peony",
                    brand: "Jo Malone",
                    gender: "Female",
                    top_season: "Spring",
                    accords: ["Floral", "Rose", "Fresh"],
                    myscore: 275.50
                },
                {
                    perfume_name: "Lanvin Eclat",
                    brand: "Lanvin",
                    gender: "Female",
                    top_season: "All",
                    accords: ["Floral", "Powdery", "Musk"],
                    myscore: 260.12
                }
            ];

            const container = document.getElementById('perfume-results-container');
            container.innerHTML = ''; // 초기화

            fakeData.forEach((item, index) => {
                const accordText = item.accords.join(' · ');
                const formattedScore = parseFloat(item.myscore).toFixed(2);

                // API에서 받아온 이미지 경로 (이미지 API 결과의 순서대로 매칭)
                const imgPath = perfumeImages[index] ? perfumeImages[index].image_url : '';

                const cardHtml = `
                    <div class="perfume-card">
                        <div class="perfume-img-slot">
                            ${imgPath
                                ? `<img src="${imgPath}" style="width:100%; height:100%; object-fit:contain;">`
                                : `<span class="material-icons" style="font-size: 50px;">shutter_speed</span>`
                            }
                        </div>
                        <div class="perfume-details">
                            <h4 class="p-name">${item.perfume_name}</h4>
                            <p class="p-brand">${item.brand}</p>
                            <p class="p-info-tags">${item.gender} · ${item.top_season}</p>
                            <p class="p-accords-list">${accordText}</p>
                            <div class="score-display-row">
                                <span class="score-label">Matching Score</span>
                                <span class="score-value">${formattedScore}</span>
                                <span class="score-max">/ 300</span>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        })
        .catch(err => console.error("향수 이미지 로드 실패:", err));
});
</script>
{% endblock %}