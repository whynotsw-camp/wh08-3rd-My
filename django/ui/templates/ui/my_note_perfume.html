{% extends 'ui/base.html' %}
{% load static %}
{% block content %}

<div class="form-container mynote-page">

  <!-- 상단 타이틀 (피그마처럼 중앙 정렬) -->
  <div class="mynote-header">
    <div class="mynote-header-center">
      <div class="mynote-title">MyNote, 지금 내 스타일에 어울리는 향수를 기록해보세요</div>
    </div>
  </div>

  <!-- 검색바 + 검색 버튼(오른쪽 붙이기) -->
  <div class="mynote-search-box">
    <div class="mynote-search-field">
      <span class="mynote-search-icon material-icons">search</span>
      <input
        type="text"
        id="perfume-search-input"
        placeholder="향수 검색"
        onkeydown="handleSearchKey(event)"
      />
    </div>

    <button type="button" class="mynote-search-btn" onclick="searchPerfume()">검색</button>
  </div>

  <!-- (빨강 영역) 검색 결과 리스트 -->
  <div id="search-result-list" class="mynote-result-list">
    <!-- 검색 전: 비어있음 -->
  </div>

  <!-- (파랑 영역) MyNote 요약 박스 -->
  <div class="mynote-cart">
    <div class="mynote-cart-title">MyNote</div>

    <div id="mynote-list" class="mynote-cart-list">
      <p class="mynote-empty">아직 저장된 향수가 없습니다.</p>
    </div>
  </div>

  <!-- 완료 버튼 (피그마처럼 우측 하단) -->
  <div class="mynote-footer">
    <button class="mynote-complete-btn" onclick="completeMyNote()">완료</button>
  </div>

</div>

<!-- =========================
     Template: 검색 결과 1줄 카드
     [이미지] [이름+브랜드] [점수입력/100] [저장]
========================== -->
<template id="result-item-template">
  <div class="mynote-result-item">
    <div class="mynote-thumb">
      <img class="mynote-thumb-img" alt="perfume"/>
    </div>

    <div class="mynote-text">
      <div class="mynote-name"></div>
      <div class="mynote-brand"></div>
    </div>

    <div class="mynote-scorebox">
      <div class="mynote-score-label">내 스타일과 향수와의 점수</div>
      <div class="mynote-score-row">
        <input class="mynote-score-input" type="number" min="0" max="100" placeholder="" />
        <span class="mynote-score-max">/100</span>
      </div>
    </div>

    <button class="mynote-pill-btn mynote-save-btn" type="button">저장</button>
  </div>
</template>

<!-- =========================
     Template: MyNote 저장 항목 1줄
     1. [이미지] [이름+브랜드] [점수/100] [삭제]
========================== -->
<template id="cart-item-template">
  <div class="mynote-cart-item">
    <div class="mynote-cart-index"></div>

    <div class="mynote-thumb">
      <img class="mynote-thumb-img" alt="perfume"/>
    </div>

    <div class="mynote-text">
      <div class="mynote-name"></div>
      <div class="mynote-brand"></div>
    </div>

    <div class="mynote-scorebox">
      <div class="mynote-score-label">내 스타일과 향수와의 점수</div>
      <div class="mynote-score-value"></div>
    </div>

    <button class="mynote-pill-btn mynote-delete-btn" type="button">삭제</button>
  </div>
</template>

<script>
const csrfToken = '{{ csrf_token }}';

/* 엔터로 검색 */
function handleSearchKey(event) {
  if (event.key === "Enter") searchPerfume();
}

/* =========================
   향수 검색
========================= */
function searchPerfume() {
  const keyword = document.getElementById("perfume-search-input").value.trim();
  const resultBox = document.getElementById("search-result-list");

  if (!keyword) {
    alert("검색어를 입력해주세요.");
    return;
  }

  fetch(`/api/my-note/perfume/search/?q=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(data => {
      resultBox.innerHTML = "";

      if (!data || data.length === 0) {
        resultBox.innerHTML = `<p class="mynote-empty">검색 결과가 없습니다.</p>`;
        return;
      }

      data.forEach(p => {
        const node = document.getElementById("result-item-template").content.cloneNode(true);

        const img = node.querySelector(".mynote-thumb-img");
        img.src = p.perfume_img_url;

        node.querySelector(".mynote-name").innerText = p.name;
        node.querySelector(".mynote-brand").innerText = p.brand ?? "";

        const scoreInput = node.querySelector(".mynote-score-input");
        scoreInput.id = `score-${p.perfume_id}`;

        node.querySelector(".mynote-save-btn").onclick = () => {
          addToCart(p.perfume_id, p.name, p.brand, p.perfume_img_url);
        };

        resultBox.appendChild(node);
      });
    })
    .catch(() => alert("향수 검색 실패"));
}

/* =========================
   장바구니 추가
========================= */
function addToCart(id, name, brand, img) {
  const scoreInput = document.getElementById(`score-${id}`);
  const score = scoreInput?.value;

  if (!score) {
    alert("점수를 입력해주세요.");
    return;
  }

  fetch('/api/my-note/perfume/cart/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
      perfume_id: id,
      perfume_name: name,
      brand: brand,
      perfume_img_url: img,
      smelling_rate: score
    })
  })
  .then(res => res.json())
  .then(data => renderCart(data.data))
  .catch(() => alert("장바구니 저장 실패"));
}

/* =========================
   장바구니 렌더
========================= */
function renderCart(cart) {
  const cartBox = document.getElementById('mynote-list');

  if (!cart || cart.length === 0) {
    cartBox.innerHTML = `<p class="mynote-empty">아직 저장된 향수가 없습니다.</p>`;
    return;
  }

  cartBox.innerHTML = "";

  cart.forEach((p, idx) => {
    const node = document.getElementById("cart-item-template").content.cloneNode(true);

    node.querySelector(".mynote-cart-index").innerText = `${idx + 1}.`;

    const img = node.querySelector(".mynote-thumb-img");
    img.src = p.perfume_img_url;

    node.querySelector(".mynote-name").innerText = p.perfume_name;
    node.querySelector(".mynote-brand").innerText = p.brand ?? "";

    node.querySelector(".mynote-score-value").innerText = `${p.smelling_rate} / 100`;

    node.querySelector(".mynote-delete-btn").onclick = () => removeFromCart(p.perfume_id);

    cartBox.appendChild(node);
  });
}

/* =========================
   장바구니 삭제
========================= */
function removeFromCart(perfumeId) {
  fetch('/api/my-note/perfume/cart/', {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ perfume_id: perfumeId })
  })
  .then(res => res.json())
  .then(data => renderCart(data.data));
}

/* =========================
   완료 (DB 저장 → 결과 페이지 이동)
========================= */
function completeMyNote() {
  fetch("/api/my-note/perfume/complete/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken
    }
  })
  .then(res => {
    if (!res.ok) throw new Error();
    return res.json();
  })
  .then(() => window.location.href = "/my-note/result/")
  .catch(() => alert("최소 한 개의 향수를 저장해주세요."));
}
</script>

{% endblock %}
