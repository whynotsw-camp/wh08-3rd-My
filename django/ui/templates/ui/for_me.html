{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- 스타일 버전 관리를 위해 파라미터 추가 -->
<link rel="stylesheet" type="text/css" href="{% static 'ui/style.css' %}?v=3.1">

<div class="form-container">
    <!-- 1. 헤더 섹션 -->
    <div class="result-header" style="text-align: center; margin-top: 40px; margin-bottom: 60px;">
        <h1 class="logo-text">MY PERFUME</h1>
        <p class="page-subtitle" style="text-align: center; color: #888; margin-bottom: 10px;">For Me, 지금의 나에게 어울리는 향은?</p>
    </div>


    <!-- 1. 코디 섹션 -->
    <div class="section">
        <div class="page-title">1. 코디(필수)</div>
        <div class="content-align">

            <!-- [BOX 1] 상의 & 하의 -->
            <div id="group-2pc" class="clothing-box">
                <div class="box-label">상의 & 하의 조합</div>

                <!-- [상의 행] -->
                <div class="outfit-row">
                    <div class="selection-area">
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('outfit-top', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-outfit-top" data-index="0">
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="top" data-value="blouse"><div class="icon-box"><img src="{% static 'ui/images/blouse.png' %}"></div><span>블라우스</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="top" data-value="tshirt"><div class="icon-box"><img src="{% static 'ui/images/tshirt.png' %}"></div><span>티셔츠</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="top" data-value="knit"><div class="icon-box"><img src="{% static 'ui/images/knit.png' %}"></div><span>니트웨어</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="top" data-value="shirt"><div class="icon-box"><img src="{% static 'ui/images/shirt.png' %}"></div><span>셔츠</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="top" data-value="hoodie"><div class="icon-box"><img src="{% static 'ui/images/hoodie.png' %}"></div><span>후드티</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('outfit-top', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('color-top', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-color-top" data-index="0">
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="white"><div class="color-circle" style="background:#FFFFFF;"></div><span>화이트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="black"><div class="color-circle" style="background:#000000;"></div><span>블랙</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="grey"><div class="color-circle" style="background:#808080;"></div><span>그레이</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="navy"><div class="color-circle" style="background:#000080;"></div><span>네이비</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="beige"><div class="color-circle" style="background:#E1C699;"></div><span>베이지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="pink"><div class="color-circle" style="background:#FFC0CB;"></div><span>핑크</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="skyblue"><div class="color-circle" style="background:#87CEEB;"></div><span>스카이블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="brown"><div class="color-circle" style="background:#8B4513;"></div><span>브라운</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="red"><div class="color-circle" style="background:#FF0000;"></div><span>레드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="blue"><div class="color-circle" style="background:#0000FF;"></div><span>블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="lavender"><div class="color-circle" style="background:#E6E6FA;"></div><span>라벤더</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="purple"><div class="color-circle" style="background:#800080;"></div><span>퍼플</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="wine"><div class="color-circle" style="background:#722F37;"></div><span>와인</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="orange"><div class="color-circle" style="background:#FFA500;"></div><span>오렌지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="yellow"><div class="color-circle" style="background:#FFFF00;"></div><span>옐로우</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="khaki"><div class="color-circle" style="background:#F0E68C;"></div><span>카키</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="mint"><div class="color-circle" style="background:#98FF98;"></div><span>민트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="green"><div class="color-circle" style="background:#008000;"></div><span>그린</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="gold"><div class="color-circle" style="background:#FFD700;"></div><span>골드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="top" data-value="silver"><div class="color-circle" style="background:#C0C0C0;"></div><span>실버</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('color-top', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div class="preview-container" id="preview-top">
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <span class="material-icons refresh-icon" onclick="fetchImages('top')">cached</span>
                    </div>
                </div>

                <!-- [하의 행] -->
                <div class="outfit-row">
                    <div class="selection-area">
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('outfit-bottom', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-outfit-bottom" data-index="0">
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="bottom" data-value="pants"><div class="icon-box"><img src="{% static 'ui/images/pants.png' %}"></div><span>팬츠</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="bottom" data-value="jeans"><div class="icon-box"><img src="{% static 'ui/images/jeans.png' %}"></div><span>청바지</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="bottom" data-value="skirt"><div class="icon-box"><img src="{% static 'ui/images/skirt.png' %}"></div><span>스커트</span></div>
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="bottom" data-value="leggings"><div class="icon-box"><img src="{% static 'ui/images/leggings.png' %}"></div><span>레깅스</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('outfit-bottom', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('color-bottom', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-color-bottom" data-index="0">
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="white"><div class="color-circle" style="background:#FFFFFF;"></div><span>화이트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="black"><div class="color-circle" style="background:#000000;"></div><span>블랙</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="grey"><div class="color-circle" style="background:#808080;"></div><span>그레이</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="navy"><div class="color-circle" style="background:#000080;"></div><span>네이비</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="beige"><div class="color-circle" style="background:#E1C699;"></div><span>베이지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="pink"><div class="color-circle" style="background:#FFC0CB;"></div><span>핑크</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="skyblue"><div class="color-circle" style="background:#87CEEB;"></div><span>스카이블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="brown"><div class="color-circle" style="background:#8B4513;"></div><span>브라운</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="red"><div class="color-circle" style="background:#FF0000;"></div><span>레드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="blue"><div class="color-circle" style="background:#0000FF;"></div><span>블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="lavender"><div class="color-circle" style="background:#E6E6FA;"></div><span>라벤더</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="purple"><div class="color-circle" style="background:#800080;"></div><span>퍼플</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="orange"><div class="color-circle" style="background:#FFA500;"></div><span>오렌지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="yellow"><div class="color-circle" style="background:#FFFF00;"></div><span>옐로우</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="khaki"><div class="color-circle" style="background:#F0E68C;"></div><span>카키</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="mint"><div class="color-circle" style="background:#98FF98;"></div><span>민트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="green"><div class="color-circle" style="background:#008000;"></div><span>그린</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="bottom" data-value="gold"><div class="color-circle" style="background:#FFD700;"></div><span>골드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="tbottomop" data-value="silver"><div class="color-circle" style="background:#C0C0C0;"></div><span>실버</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('color-bottom', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div class="preview-container" id="preview-bottom">
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <span class="material-icons refresh-icon" onclick="fetchImages('bottom')">cached</span>
                    </div>
                </div>
            </div>

            <!-- [BOX 2] 원피스 -->
            <div id="group-1pc" class="clothing-box">
                <div class="box-label">원피스</div>
                <div class="outfit-row">
                    <div class="selection-area">
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('outfit-onepiece', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-outfit-onepiece" data-index="0">
                                    <div class="outfit-item" onclick="selectOutfit(this)" data-type="onepiece" data-value="dress"><div class="icon-box"><img src="{% static 'ui/images/dress.png' %}"></div><span>드레스</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('outfit-onepiece', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                        <div class="slider-wrapper">
                            <button class="nav-btn" onclick="moveSlider('color-onepiece', -1)"><span class="material-icons">chevron_left</span></button>
                            <div class="slider-window">
                                <div class="slider-track" id="track-color-onepiece" data-index="0">
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="white"><div class="color-circle" style="background:#FFFFFF;"></div><span>화이트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="black"><div class="color-circle" style="background:#000000;"></div><span>블랙</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="grey"><div class="color-circle" style="background:#808080;"></div><span>그레이</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="navy"><div class="color-circle" style="background:#000080;"></div><span>네이비</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="beige"><div class="color-circle" style="background:#E1C699;"></div><span>베이지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="pink"><div class="color-circle" style="background:#FFC0CB;"></div><span>핑크</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="skyblue"><div class="color-circle" style="background:#87CEEB;"></div><span>스카이블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="brown"><div class="color-circle" style="background:#8B4513;"></div><span>브라운</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="red"><div class="color-circle" style="background:#FF0000;"></div><span>레드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="blue"><div class="color-circle" style="background:#0000FF;"></div><span>블루</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="lavender"><div class="color-circle" style="background:#E6E6FA;"></div><span>라벤더</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="purple"><div class="color-circle" style="background:#800080;"></div><span>퍼플</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="wine"><div class="color-circle" style="background:#722F37;"></div><span>와인</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="orange"><div class="color-circle" style="background:#FFA500;"></div><span>오렌지</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="yellow"><div class="color-circle" style="background:#FFFF00;"></div><span>옐로우</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="khaki"><div class="color-circle" style="background:#F0E68C;"></div><span>카키</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="mint"><div class="color-circle" style="background:#98FF98;"></div><span>민트</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="green"><div class="color-circle" style="background:#008000;"></div><span>그린</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="gold"><div class="color-circle" style="background:#FFD700;"></div><span>골드</span></div>
                                    <div class="color-item" onclick="selectColor(this)" data-type="onepiece" data-value="silver"><div class="color-circle" style="background:#C0C0C0;"></div><span>실버</span></div>
                                </div>
                            </div>
                            <button class="nav-btn" onclick="moveSlider('color-onepiece', 1)"><span class="material-icons">chevron_right</span></button>
                        </div>
                    </div>
                    <div class="preview-container" id="preview-onepiece">
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <div class="preview-box">Img</div><div class="preview-box">Img</div>
                        <span class="material-icons refresh-icon" onclick="fetchImages('onepiece')">cached</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!---------------------------------------------------------------->
    <!-- 2. 계절 섹션 -->
    <div class="section">
        <div class="page-title">2. 계절(필수)</div>
        <div class="content-align">
            <div class="btn-group" id="season-group">
                <button class="selection-btn" onclick="toggleSingle(this)" data-value="spring">봄</button>
                <button class="selection-btn" onclick="toggleSingle(this)" data-value="summer">여름</button>
                <button class="selection-btn" onclick="toggleSingle(this)" data-value="fall">가을</button>
                <button class="selection-btn" onclick="toggleSingle(this)" data-value="winter">겨울</button>
            </div>
        </div>
    </div>
<!---------------------------------------------------------------->
    <!-- 3. 비선호 취향 섹션 (38개 향조 전체 포함) -->
    <div class="section content-align">
        <div class="page-title">3. 비선호 취향 (선택)</div>
        <p style="font-size: 13px; color: #999; margin-bottom: 15px;">카테고리를 클릭하여 싫어하는 향조를 선택하세요.</p>

        <!-- 카테고리 1: 상큼 & 시원 -->
        <div class="accord-category">
            <div class="accord-header" onclick="toggleCategory(this)">
                <span>상큼 & 시원 (Citrus & Fresh)</span>
                <span class="material-icons arrow">expand_more</span>
            </div>
            <div class="accord-content">
                <div class="btn-group">
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="citrus">시트러스</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="fresh">프레시</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="green">그린</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="aquatic">아쿠아틱</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="marine">마린</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="ozonic">오조닉</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="mineral">미네랄</button>
                </div>
            </div>
        </div>

        <!-- 카테고리 2: 플로럴 -->
        <div class="accord-category">
            <div class="accord-header" onclick="toggleCategory(this)">
                <span>플로럴 (Floral)</span>
                <span class="material-icons arrow">expand_more</span>
            </div>
            <div class="accord-content">
                <div class="btn-group">
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="rose">로즈</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="white floral">화이트 플로럴</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="yellow floral">옐로우 플로럴</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="iris">아이리스</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="violet">바이올렛</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="tuberose">튜베로즈</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="lavender">라벤더</button>
                </div>
            </div>
        </div>

        <!-- 카테고리 3: 달콤 & 푸드 -->
        <div class="accord-category">
            <div class="accord-header" onclick="toggleCategory(this)">
                <span>달콤 & 푸드 (Sweet & Gourmand)</span>
                <span class="material-icons arrow">expand_more</span>
            </div>
            <div class="accord-content">
                <div class="btn-group">
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="vanilla">바닐라</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="sweet">스위트</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="fruity">프루티</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="cherry">체리</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="coconut">코코넛</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="almond">아몬드</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="honey">허니</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="coffee">커피</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="lactonic">락토닉</button>
                </div>
            </div>
        </div>

        <!-- 카테고리 4: 우디 & 머스크 -->
        <div class="accord-category">
            <div class="accord-header" onclick="toggleCategory(this)">
                <span>우디 & 머스크 (Woody & Musk)</span>
                <span class="material-icons arrow">expand_more</span>
            </div>
            <div class="accord-content">
                <div class="btn-group">
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="woody">우디</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="oud">오드</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="patchouli">패출리</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="earthy">어시</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="mossy">모시</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="musky">머스키</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="powdery">파우더리</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="aromatic">아로마틱</button>
                </div>
            </div>
        </div>

        <!-- 카테고리 5: 무겁고 독특함 -->
        <div class="accord-category">
            <div class="accord-header" onclick="toggleCategory(this)">
                <span>무겁고 독특함 (Heavy & Unique)</span>
                <span class="material-icons arrow">expand_more</span>
            </div>
            <div class="accord-content">
                <div class="btn-group">
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="smoky">스모키</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="tobacco">타바코</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="leather">레더</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="warm spicy">웜 스파이시</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="soft spicy">소프트 스파이시</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="animalic">애니멀릭</button>
                    <button class="selection-btn" onclick="toggleMulti(this)" data-value="aldehydic">알데히딕</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 제출 버튼 -->
    <div class="submit-container">
        <button class="submit-btn" onclick="submitSelection()">완료</button>
    </div>
</div>

<script>
    // 전역 선택 상태 객체
    const selections = {
        top: {item: null, color: null},
        bottom: {item: null, color: null},
        onepiece: {item: null, color: null}
    };

    // 1. 슬라이더 이동 로직
    function moveSlider(trackId, direction) {
        const track = document.getElementById('track-' + trackId);
        if(!track) return;
        const isColor = trackId.includes('color');
        const visibleCount = isColor ? 6 : 4;
        const step = isColor ? 77 : 97;

        let currentIndex = parseInt(track.getAttribute('data-index') || "0");
        let newIndex = currentIndex + direction;
        const maxIndex = track.children.length - visibleCount;

        if (newIndex < 0) newIndex = 0;
        if (newIndex > maxIndex && maxIndex > 0) newIndex = maxIndex;

        track.style.transform = `translateX(-${newIndex * step}px)`;
        track.setAttribute('data-index', newIndex);
    }

    // 2. [핵심] 상하의 vs 원피스 상호 활성화/비활성화 제어
    function refreshGroupState() {
        const g2 = document.getElementById('group-2pc');
        const g1 = document.getElementById('group-1pc');

        // 상하의 섹션 중 하나라도 선택된 데이터가 있는지 확인
        const hasTop = selections.top.item || selections.top.color;
        const hasBottom = selections.bottom.item || selections.bottom.color;
        const has2pc = hasTop || hasBottom;

        // 원피스 섹션 중 하나라도 선택된 데이터가 있는지 확인
        const has1pc = selections.onepiece.item || selections.onepiece.color;

        if (has2pc) {
            // 상하의 선택 시 원피스 비활성화
            g1.classList.add('disabled');
            g2.classList.remove('disabled');
        } else if (has1pc) {
            // 원피스 선택 시 상하의 비활성화
            g2.classList.add('disabled');
            g1.classList.remove('disabled');
        } else {
            // 아무것도 선택되지 않았을 때 둘 다 활성화 (복구)
            g1.classList.remove('disabled');
            g2.classList.remove('disabled');
        }
    }

    // 3. 옷 아이템 선택 (Toggle 적용)
    function selectOutfit(el) {
        const type = el.getAttribute('data-type');
        const val = el.getAttribute('data-value');

        if (el.classList.contains('selected')) {
            // 이미 선택된 것을 누르면 해제
            el.classList.remove('selected');
            selections[type].item = null;
        } else {
            // 새로 선택
            el.parentElement.querySelectorAll('.outfit-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            selections[type].item = val;
        }
        refreshGroupState();
        fetchImages(type);
    }

    // 4. 색상 선택 (Toggle 적용)
    function selectColor(el) {
        const type = el.getAttribute('data-type');
        const val = el.getAttribute('data-value');

        if (el.classList.contains('selected')) {
            // 이미 선택된 것을 누르면 해제
            el.classList.remove('selected');
            selections[type].color = null;
        } else {
            // 새로 선택
            el.parentElement.querySelectorAll('.color-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            selections[type].color = val;
        }
        refreshGroupState();
        fetchImages(type);
    }

    // 5. 이미지 미리보기 가져오기 및 이미지 선택 토글
    function fetchImages(category) {
        const { item, color } = selections[category];
        const container = document.getElementById(`preview-${category}`);
        if (!container) return;
        const boxes = container.querySelectorAll('.preview-box');

        // 종류나 색상 중 하나라도 해제되면 프리뷰 초기화
        if (!item || !color) {
            boxes.forEach(box => { box.innerHTML = 'Img'; box.classList.remove('selected'); });
            return;
        }

        // 이미지 필터링 API 호출
        fetch(`/api/filter-images/?category=${category}&item=${item}&color=${color}`)
            .then(res => res.json())
            .then(data => {
                boxes.forEach((box, i) => {
                    box.innerHTML = '';
                    box.classList.remove('selected');
                    if (data.images && data.images[i]) {
                        const img = document.createElement('img');
                        img.src = data.images[i];
                        box.appendChild(img);
                        // 이미지도 클릭하면 'selected' 상태 토글
                        box.onclick = function() {
                            if (this.classList.contains('selected')) {
                                this.classList.remove('selected');
                            } else {
                                boxes.forEach(b => b.classList.remove('selected'));
                                this.classList.add('selected');
                            }
                        };
                    } else {
                        box.innerText = 'No Img';
                    }
                });
            })
            .catch(err => console.error("이미지 로딩 에러:", err));
    }

    // 6. 단일 선택 버튼 (성별/계절) Toggle
    function toggleSingle(el) {
        const parent = el.parentElement;
        const isSelected = el.classList.contains('active');

        if (isSelected) {
            el.classList.remove('active');
        } else {
            parent.querySelectorAll('.selection-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        }
    }

    // 7. 다중 선택 버튼 (비선호 향조) Toggle
    function toggleMulti(el) {
        el.classList.toggle('active');
    }

    // 8. 아코디언 토글 로직
    function toggleCategory(header) {
        const category = header.parentElement;
        category.classList.toggle('active');
    }

    // 9. 최종 제출 로직
    function submitSelection() {


    // 1. 계절 선택 여부 확인
    const seasonBtn = document.querySelector('#season-group .active');
    if (!seasonBtn) {
        alert("계절을 선택해주세요!");
        return;
    }

    // 2. 이미지 선택 여부 수집
    const selectedTopImg = document.querySelector('#preview-top .preview-box.selected img')?.getAttribute('src');
    const selectedBottomImg = document.querySelector('#preview-bottom .preview-box.selected img')?.getAttribute('src');
    const selectedOnepieceImg = document.querySelector('#preview-onepiece .preview-box.selected img')?.getAttribute('src');

    // 3. [추가] 코디 선택 여부 검증 로직
    const isTwoPieceActive = !document.getElementById('group-2pc').classList.contains('disabled');
    const isOnePieceActive = !document.getElementById('group-1pc').classList.contains('disabled');

    // 검증 실행
    if (isTwoPieceActive) {
        // 상하의 모드인데 이미지를 둘 다 안 골랐거나 하나만 고른 경우
        if (!selectedTopImg || !selectedBottomImg) {
            alert("상의와 하의 코디 이미지를 모두 선택해주세요!");
            return;
        }
    } else if (isOnePieceActive) {
        // 원피스 모드인데 이미지를 안 고른 경우
        if (!selectedOnepieceImg) {
            alert("원피스 코디 이미지를 선택해주세요!");
            return;
        }
    } else {
        // 아예 아무것도 건드리지 않은 초기 상태인 경우
        alert("원하시는 코디를 선택하고 이미지를 클릭해 주세요!");
        return;
    }

    // 4. 모든 검증 통과 시 데이터 전송
    const requestData = {
        season: seasonBtn.dataset.value,
        disliked_accords: Array.from(document.querySelectorAll('.accord-category .selection-btn.active')).map(b => b.dataset.value),
        top: selections.top.item,
        top_color: selections.top.color,
        top_img: selectedTopImg,
        bottom: selections.bottom.item,
        bottom_color: selections.bottom.color,
        bottom_img: selectedBottomImg,
        onepiece: selections.onepiece.item,
        onepiece_color: selections.onepiece.color,
        onepiece_img: selectedOnepieceImg
    };

    fetch('/api/user-input/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.getElementById('csrf_token').value
        },
        body: JSON.stringify(requestData)
    })
    .then(res => {
        if (res.ok) window.location.href = "/result/";
        else alert("데이터 저장 중 오류가 발생했습니다.");
    })
    .catch(err => console.error("제출 에러:", err));
}
</script>
{% endblock %}